### Настройка простого VPN подключения для тестирования

```ruby
# На сервере
sudo openvpn --remote 192.168.50.147 --dev tun0 --ifconfig 10.0.0.1 10.0.0.2

# На клиенте
sudo openvpn --remote 192.168.50.133 --dev tun0 --ifconfig 10.0.0.2 10.0.0.1
```


<br>

### Настройка простого VPN шифрования со статическими ключами

_**Задача:** Добавить шифрование для OpenVPN максимально простым способом._

Самый простой способ настроить шифрование — применить общие статические ключи. Они удобны для тестирования, но не подходят для использования в промышленном окружении. 

В следующих примерах сервер `OpenVPN` находится на `server1`, клиент — на `client1`, а новый ключ — в файле `myvpn.key`. Но, вообще говоря, ключи можно хранить в файлах с любыми именами.

Выполните эти шаги:

**1)** создайте общий статический ключ и передайте на два хоста;  
**2)** создайте конфигурационные файлы для сервера и клиента;  
**3)** запустите OpenVPN на обоих хостах, использовав ссылки на их конфигурационные файлы.  

Создайте новый каталог на `сервере` OpenVPN для хранения ключей, затем создайте новый статический ключ:

_**На сервере**_

```ruby
sudo mkdir /etc/openvpn/keys
sudo openvpn --genkey secret /etc/openvpn/keys/myvpn.key
```
![image](https://github.com/user-attachments/assets/6817fd6d-23df-43a2-b496-c55b814c1f6e)


```ruby
# server1.conf
dev tun
ifconfig 10.0.0.1 10.0.0.2
secret /etc/openvpn/keys/myvpn.key
local 192.168.50.133
```

![image](https://github.com/user-attachments/assets/de36d250-4da1-41bc-9450-065cd17f8344)


_**На клиенте**_

```ruby
# Нужно создать папку и скопировать ключ myvpn.key с сервера
sudo mkdir /etc/openvpn/keys
scp ikozhuhar@192.168.50.133:/etc/openvpn/keys/myvpn.key .
```
![image](https://github.com/user-attachments/assets/6817fd6d-23df-43a2-b496-c55b814c1f6e)


```ruby
# client1.conf
dev tun
ifconfig 10.0.0.2 10.0.0.1
secret /etc/openvpn/keys/myvpn.key
remote 192.168.50.133
```

![image](https://github.com/user-attachments/assets/392e6c0c-504f-47a2-89b8-623575fa85fb)

```ruby
sudo openvpn /etc/openvpn/server1.conf
```

![image](https://github.com/user-attachments/assets/9dd65fef-bcfa-4331-8768-480cd525d8f5)

![image](https://github.com/user-attachments/assets/7df219c7-4b04-4348-a9a4-7b1e15a54559)

```ruby
ping -I tun0 10.0.0.1
ping -I tun0 10.0.0.2
```
![image](https://github.com/user-attachments/assets/abafe2ba-5a7e-41e3-9740-84b31d3b7e09)



<br>

### Установка EasyRSA для управления инфраструктурой PKI

Инфраструктура открытых ключей (PKI) может располагаться где угодно, причем не обязательно на сервере OpenVPN. Вы должны создать сертификаты сервера и клиента в PKI, а затем скопировать их на соответствующие хосты.

Fedora и Ubuntu помещают все файлы EasyRSA в рабочий каталог /usr/share/. Он не является самым лучшим, поскольку перезаписывается системными обновлениями. Создайте новый каталог, которым управляете только вы, и в месте, где не нужны права root, как в нашем примере с пользователем Duchess, который создал каталог /home/duchess/mypki:

```ruby
# Вы можете установить пакет easy-rsa
apt install easy-rsa

# Каталог для хранения инфраструктуры открытых ключей
mkdir mypki

# скопируйте каталог /usr/share/easy-rsa в созданный вами каталог:
sudo cp -r /usr/share/easy-rsa mypki
```

В результате будет создан каталог `mypki/easy-rsa`. Проверьте его разрешения; владельцами всего, что находится в этом каталоге, должны быть вы и ваша группа.

Комментарий

Для создания инфраструктуры PKI и управления ею не нужны права root. Вы можете разместить ее где угодно, и она должна быть отделена от вашей конфигурации OpenVPN, то есть находиться в отдельном каталоге или на отдельном компьютере. Те, кто давно работает с OpenVPN, рекомендуют устанавливать инфраструктуру на хорошо защищенную машину, не подключенную к Интернету.


### Создание инфраструктуры PKI

После установки EasyRSA нужно правильно настроить инфраструктуру открытых ключей (Public Key Infrastructure, PKI)

Создание инфраструктуры PKI включает следующие шаги:

1) создать собственный сертификат центра сертификации (CA) для подписи сертификатов сервера и клиента. Он должен храниться отдельно от конфигурации сервера OpenVPN — в отдельном каталоге или на отдельном компьютере;
2) создать и подписать сертификат сервера OpenVPN;
3) создать и подписать клиентские сертификаты;
4) скопировать сертификаты сервера и клиентов в /etc/openvpn/keys на соответствующие компьютеры. (Имя каталога может быть другим, отличным от keys.)

Перейдите в каталог инфраструктуры и выполните команду ее инициализации:

```ruby
# Она создаст пустую структуру каталогов для новой PKI.
~$ cd mypki
~/mypki $ easyrsa init-pki

# Затем создайте новый центр сертификации. ЦС создает и подписывает сертификаты сервера и клиентов
~/mypki $ easyrsa build-ca
```

Сгенерируйте запрос на СОЗДАНИЕ пары ключей и подписание сертификата для вашего СЕРВЕРА OpenVPN. Обычно не принято добавлять парольную фразу в закрытый ключ сервера, но вы можете защитить его паролем, если хотите, опустив параметр nopass. Парольная фраза обеспечивает надежную защиту, но тогда вам придется вводить ее каждый раз при перезапуске сервера:

```ruby
~/mypki $ easyrsa gen-req vpnserver1 nopass
```

Сгенерируйте запрос на создание пары ключей и подписание сертификата для клиента.

```ruby
~/mypki $ easyrsa gen-req vpnclient1
```

Подпишите запросы, используя общие имена (Common Name) сервера и клиента. Используйте только имена; если вы введете их пути, то это приведет к ошибке:

```ruby
~/mypki $ easyrsa sign-req server vpnserver1
~/mypki $ easyrsa sign-req client vpnclient1
```

Создайте на сервере ключ HMAC (Hash-based Message Authentication Code — код аутентификации сообщения на основе хеш-функции):

```ruby
$ openvpn --genkey --secret ta.key
```

Скопируйте vpnclient1.key, vpnclient1.crt, ca.crt и ta.key в каталог `/etc/openvpn/keys` на машине `client1`.

Скопируйте vpnserver1.key, vpnserver1.crt, ca.crt, dh.pem и ta.key в каталог `/etc/openvpn/keys` на машине `server1`.

После подписания запроса на подпись сертификата можно удалить все файлы `*.req`.

