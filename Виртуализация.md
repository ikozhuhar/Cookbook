## Виртуализация: KVM

```ruby
$ sudo apt install qemu-kvm qemu-utils libvirt-daemon bridge-utils libvirt-kvm virt-manager
$ sudo gpasswd -a padmin vmusers
$ sudo systemctl enable --now libvirtd
```

### Типы виртуальных машин

#### Полностью виртуализированный

Все инструкции, которые должна выполнять гостевая операционная система, выполняться в полностью виртуализированной установке операционной системы. Причина этого в том, что в гостевой системе не устанавливаются дополнительные программные драйверы для перевода инструкций на имитируемое или реальное оборудование. Полностью виртуализированный гость — это тот, в котором гость (или HardwareVM) не знает, что он является запущенным экземпляром виртуальной машины. Для того чтобы этот тип виртуализации выполнялся на оборудовании на базе x86, расширения ЦП Intel VT-x или AMD-V должны быть включены в системе, в которой установлен гипервизор. Это можно сделать из меню конфигурации прошивки BIOS или UEFI.

#### Паравиртуализированный

Паравиртуализированный гость (или PVM) — это тот, в котором гостевая операционная система знает, что он является запущенным экземпляром виртуальной машины. Эти типы гостей будут использовать модифицированное ядро и СПЕЦИАЛЬНЫЕ ДРАЙВЕРЫ (известные как гостевые драйверы), которые помогут гостевой операционной системе ИСПОЛЬЗОВАТЬ ПРОГРАММНЫЕ И АППАРАТНЫЕ РЕСУРСЫ ГИПЕРВИЗОРА. ПРОИЗВОДИТЕЛЬНОСТЬ паравиртуализированного гостя часто ВЫШЕ, чем у полностью виртуализированного гостя из-за ПРЕИМУЩЕСТВ, которые предоставляют эти ПРОГРАММНЫЕ ДРАЙВЕРЫ.
	
#### Гибрид

Паравиртуализацию и полную виртуализацию можно объединить, чтобы позволить немодифицированным операционным системам получить почти нативную производительность ввода-вывода, используя паравиртуализированные драйверы в полностью виртуализированных операционных системах. Паравиртуализированные драйверы содержат драйверы устройств хранения и сетевых устройств с улучшенной производительностью дискового и сетевого ввода-вывода.


### Пример виртуальной машины libvirt

ВИРТУАЛЬНАЯ МАШИНА ЧАСТО СОСТОИТ ИЗ ГРУППЫ ФАЙЛОВ, в первую очередь XML-файла, который определяет виртуальную машину (например, ее аппаратную конфигурацию, сетевое подключение, возможности отображения и т. д.), и связанного файла образа жесткого диска, который содержит установку операционной системы и ее программного обеспечения.

1. Пример XML-файла конфигурации для виртуальной машины и ее сетевой среды:

```ruby
$ ls /etc/libvirt/qemu
drwxr-xr-x 3 root root 4096 Oct 29 17:48 networks
-rw------- 1 root root 5667 Jun 29 17:17 ubuntu22.04.xml

$ sudo cat /etc/libvirt/qemu/networks/default.xml
	<network>
	  <name>default</name>
	  <uuid>55ab064f-62f8-49d3-8d25-8ef36a524344</uuid>
	  <forward mode='nat'/>
	  <bridge name='virbr0' stp='on' delay='0'/>
	  <mac address='52:54:00:b8:e0:15'/>
	  <ip address='192.168.122.1' netmask='255.255.255.0'>
		<dhcp>
		  <range start='192.168.122.2' end='192.168.122.254'/>
		</dhcp>
	  </ip>
	</network>
```

Каталог networks содержит файлы определений (также с использованием XML), которые создают конфигурации сети, которые могут использовать виртуальные машины. Этот гипервизор использует только одну сеть, и поэтому есть только один файл определений, который содержит конфигурацию для сегмента виртуальной сети, который будут использовать эти системы. Это определение включает в себя частную сеть класса C и эмулированное аппаратное устройство, которое будет действовать как маршрутизатор для этой сети. Также существует диапазон IP-адресов для использования гипервизором с реализацией DHCP-сервера, который может быть назначен виртуальным машинам, использующим эту сеть. Эта сетевая конфигурация также использует трансляцию сетевых адресов (NAT) для пересылки пакетов в другие сети, такие как локальная сеть гипервизора.

	
#### 2. Файл определения виртуальной машины

```ruby
$ sudo cat /etc/libvirt/qemu/ubuntu22.04.xml
```


#### 3. Пример дискового хранилища виртуальной машины

```ruby
# Образ жесткого диска этой виртуальной машины находится в /var/lib/libvirt/images/ubuntu22.04.qcow2
-rw------- 1 root root 5.5G Oct 25 15:57 /var/lib/libvirt/images/ubuntu22.04.qcow2
```

#### 4. Типы образов дисков

`COW`  
Копирование при записи (также называемое тонким выделением или разреженными образами) — это метод, при котором файл диска создается с предопределенным верхним пределом размера. Размер образа диска увеличивается только по мере записи новых данных на диск. Как и в предыдущем примере, гостевая операционная система видит предопределенный предел диска в 23,3 ГБ, но записала в файл диска только 5,5 ГБ данных. Формат образа диска, используемый для примера виртуальной машины, — qcow2, который является форматом файла QEMU COW.

`RAW`  
Тип необработанного или полного диска — это файл, в котором все его пространство предварительно выделено. Например, файл необработанного образа диска размером 10 ГБ занимает 10 ГБ фактического дискового пространства на гипервизоре. Этот тип диска имеет ПРЕИМУЩЕСТВО В ПРОИЗВОДИТЕЛЬНОСТИ, поскольку все необходимое дисковое ПРОСТРАНСТВО УЖЕ СУЩЕСТВУЕТ, поэтому базовый гипервизор может просто записывать данные на диск БЕЗ СНИЖЕНИЯ ПРОИЗВОДИТЕЛЬНОСТИ, СВЯЗАННОГО С МОНИТОРИНГОМ образа диска, чтобы УБЕДИТЬСЯ, что он еще НЕ ДОСТИГ СВОЕГО ПРЕДЕЛА, и расширением размера файла по мере записи на него новых данных.


#### 5. Запуск виртуальной машины

1. Через графический интерфейс (virt-manager)

virt-manager
(Запустит GUI для создания и управления VM).

2. Через CLI (пример)

```ruby
# Перед запуском команды нужно создать образ диска и задать допустимое имя для vm
sudo virt-install \
   --name=ubuntu20.04 \
   --ram=2048 \
   --vcpus=2 \
   --disk path=/var/lib/libvirt/images/ubuntu22.04.1.qcow2,size=25 \
   --os-variant=ubuntu22.04 \
   --network bridge=virbr0 \
   --graphics spice \
   --cdrom=/home/padmin/Загрузки/ubuntu-24.04.2-live-server-amd64.iso
```


#### 6. Создание образа диска

```ruby
# Смотрим образы дисков
ls -la /var/lib/libvirt/images/
qemu-img info /var/lib/libvirt/images/ubuntu22.04.qcow2

# Создаем диска на 10G
qemu-img create -f qcow2 /var/lib/libvirt/images/ubuntu22.04.1.qcow2 10G
qemu-img info /var/lib/libvirt/images/ubuntu22.04.1.qcow2

# Смотрим допустимые имена для VM
osinfo-query os | grep ubuntu
```


#### 7. Управление VM

```ruby
# Список ВМ:
virsh list --all

# Запуск/остановка:
virsh start ubuntu22.04
virsh shutdown ubuntu22.04

# Удаление:
virsh undefine ubuntu22.04

# Идентификатор машины D-Bus
$ dbus-uuidgen --ensure

# Просмотреть текущий идентификатор 
$ dbus-uuidgen --get

# Посмотреть работающие машины
$ virsh list --all
$ virsh shutdown ubuntu22.04
$ virsh start ubuntu22.04

# Идентификатор машины D-Bus
Идентификатор машины D-Bus находится в /var/lib/dbus/machine-id и символически связан с /etc/machine-id. Изменение этого номера ID в работающей системе не рекомендуется, поскольку это может привести к нестабильности системы и сбоям. Если две виртуальные машины имеют одинаковый идентификатор машины D-Bus, выполните следующую процедуру, чтобы сгенерировать новый:

$ sudo rm -f /etc/machine-id
$ sudo dbus-uuidgen --ensure=/etc/machine-id

В случае, если /var/lib/dbus/machine-id не является символической ссылкой на /etc/machine-id, то /var/lib/dbus/machine-id необходимо удалить.
```


#### TROUBLESHOOTING

```ruby
# Ошибка запуска requested operation is not valid: network default is not active
sudo virsh net-list --all
sudo virsh net-start default
sudo virsh net-autostart --network default
sudo virsh net-list --all

# Идентификатор машины D-Bus
$ dbus-uuidgen --ensure

# Просмотреть текущий идентификатор 
$ dbus-uuidgen --get

# Посмотреть работающие машины
$ virsh list --all
$ virsh shutdown ubuntu22.04
$ virsh start ubuntu22.04

# Если две виртуальные машины имеют одинаковый идентификатор машины D-Bus, выполните следующую процедуру, чтобы сгенерировать новый:
$ sudo rm -f /etc/machine-id
$ sudo dbus-uuidgen --ensure=/etc/machine-id
В случае, если /var/lib/dbus/machine-id не является символической ссылкой на /etc/machine-id, то /var/lib/dbus/machine-id необходимо удалить.
```
