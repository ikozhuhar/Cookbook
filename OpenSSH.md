## Безопасный удаленный доступ с OpenSSH

OpenSSH — популярный инструмент для безопасного удаленного администрирования. Он шифрует весь трафик, передаваемый во время сеанса, и гарантирует целостность передачи данных. В данной главе вы узнаете, как настроить доступ к удаленным хостам через SSH, управлять своими ключами шифрования, настроить свои учетные данные на нескольких удаленных хостах, настроить приглашение Bash, чтобы отличать сеансы SSH, и многое другое.

OpenSSH — это набор утилит для передачи данных по сети:

| Компонент | Роль |
| ------- | ----------- |
| `sshd` | демон сервера OpenSSH |
| `ssh` | сокращенно от secure shell («безопасная оболочка»), но на самом деле не включает оболочку, а обеспечивает безопасный канал связи с командной оболочкой в удаленной системе |
| `scp` | сокращенно от secure copy («безопасное копирование»), предназначена для шифрованной передачи файлов |
| `sftp` | («протокол безопасной передачи файлов»), обеспечивает доступ к файлам |
| `ssh-copy-id` | замечательная маленькая программа для сохранения вашего открытого ключа в файле `authorized_keys` на удаленном сервере SSH |
| `ssh-keyscan` | отыскивает и собирает открытые ключи хостов в сети, избавляя от необходимости искать их вручную |
| `ssh-keygen` | генерирует ключи аутентификации и управляет ими |
| `ssh-add` | добавляет вашу идентификационную информацию в настройки агента аутентификации ssh-agent |

В этой главе вы познакомитесь с `ssh`, `sshd`, `ssh-copy-id`, `ssh-keygen` и двумя полезными утилитами: `sshfs` и `ssh-agent`

```ruby
# Конфигурационный файл
/etc/ssh/sshd_config

# Проверка правильности атрибутов файлов и домашних каталогов пользователей, прежде чем принимать от них запросы на подключение:
StrictModes yes

# Указать с какого адреса принимать запросы
ListenAddress 192.168.10.15
```


Можно назначить нестандартные порты для приема соединений сервером `sshd`. Используйте только порты выше 1024 и загляните в `/etc/services`, чтобы выбрать неиспользуемые порты, затем добавьте новые порты в `/etc/services`:

```ruby
# Файл /etc/services
sshd 2022
sshd 2023

# Файл /etc/ssh/sshd_config:
Port 2022
Port 2023
```

Можно разрешить доступ только указанным группам (создайте эти группы в `/etc/group`):

```ruby
AllowGroups webadmins backupadmins
```

Отключите возможность входа с привилегиями `root`. Безопаснее входить в систему с привилегиями рядового пользователя и затем использовать `sudo`:

```ruby
PermitRootLogin no

# Как вариант, можно разрешить вход с привилегиями **root**, но только методом аутентификации с открытым ключом
PermitRootLogin prohibit-password
```

Можно отключить вход с паролем для всех пользователей и разрешить только аутентификацию с открытым ключом:

```ruby
PasswordAuthentication no
```

Можно запретить вход конкретным пользователям, перечислив их имена, имена хостов или IP-адреса. Или разрешить вход ограниченному кругу пользователей, определив параметр `AllowUsers`. Вы можете задействовать оба параметра, но помните при этом, что `DenyUsers` всегда обрабатывается первым.

```ruby
DenyUsers duchess madmax stash@example.com cagney@192.168.10.25
```

Ограничьте время ожидания, пока пользователь введет свои учетные данные и завершит процедуру входа в систему. По умолчанию 120 секунд

```ruby
LoginGraceTime 90
```

Можно также ограничить количество неудачных попыток входа. По умолчанию

```ruby
MaxAuthTries 4
```


<br>

### Управление несколькими открытыми ключами

Чтобы упростить управление несколькими открытыми ключами, создайте новый файл `~/.ssh.config`. Он настраивает учетные данные для подключения к различным удаленным хостам; произведя такие настройки, можно выполнять вход спомощью простой короткой команды `ssh foo`. В этот файл можно добавить все используемые вами открытые ключи, например:

```ruby
Host server3
 HostName server3
 User duchess
 IdentityFile ~/.ssh/id-server3
 IdentitiesOnly yes
 
Host server3
 HostName server3
 User madmax
 IdentityFile ~/.ssh/id-server3
 IdentitiesOnly yes
```

- `Host` определяет начало блока настроек для каждого отдельного хоста. Это метка, которая будет использоваться для входа в систему, и она может быть любой строкой.
- `HostName` — имя хоста удаленного компьютера, полное доменное имя или IP-адрес.
- `User` — имя пользователя на удаленной машине.
- `IdentityFile` — полный путь к файлу с вашим открытым ключом.
- `IdentitiesOnly yes` — указывает ssh использовать настройки в `~/.ssh/config` или из параметров командной строки, а не из других источников, если они есть



<br>

### Изменение парольной фразы

_**Задача:** Изменить парольную фразу на выбранном закрытом ключе._

```ruby
# Используйте команду ssh-keygen с параметром -p:
$ ssh-keygen -p -f ~/.ssh/id-server2
```


<br>

### Открытие сеанса SSH и запуск команды одной строкой

_**Задача:** Нужно выполнить единственную команду на удаленном компьютере._

```ruby
# Ниже представлен пример перезапуска Postfix:
$ ssh mailadmin@server2.example.com sudo systemctl restart postfix
```


<br>

### Монтирование удаленной файловой системы через sshfs

`sshfs` — инструмент, предназначенный для монтирования удаленных файловых систем и последующего доступа к ним как к локальной файловой системе, без хлопот по настройке сервера `NFS` или `Samba`.

**На сервере**

```ruby
sudo apt install sshfs
sudo mkdir /mnt/sshfs
```

**На клиенте**

```ruby
sudo mkdir /mnt/sshfs

# Монтирования удаленного каталога в свой локальный каталог sshfs
sudo sshfs administrator@192.168.11.137:/mnt/sshfs /mnt/sshfs/
sudo sshfs administrator@192.168.11.137:/home/administrator/Desktops/Desktop1 /mnt/sshfs

# Завершив работу с удаленной файловой системой
sudo fusermount -u sshfs
```

![image](https://github.com/user-attachments/assets/311cfce0-9b87-4b77-b08b-4e5457876405)

